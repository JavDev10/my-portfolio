---

---

<canvas id="background-canvas"></canvas>

<script>
    let canvas: HTMLCanvasElement | null;
    let ctx: CanvasRenderingContext2D | null;
    let particles: Particle[] = [];
    let mouse = { x: 0, y: 0 };
    let animationId: number;

    class Particle {
        x: number = 0;
        y: number = 0;
        size: number = 0;
        speedX: number = 0;
        speedY: number = 0;
        color: string = "";

        constructor() {
            if (!canvas) return;
            this.x = Math.random() * canvas.width;
            this.y = Math.random() * canvas.height;
            this.size = Math.random() * 2;
            this.speedX = Math.random() * 0.5 - 0.25;
            this.speedY = Math.random() * 0.5 - 0.25;
            this.color = `rgba(139, 92, 246, ${Math.random() * 0.5})`;
        }

        update() {
            if (!canvas) return;
            this.x += this.speedX;
            this.y += this.speedY;

            const dx = mouse.x - this.x;
            const dy = mouse.y - this.y;
            const distance = Math.sqrt(dx * dx + dy * dy);

            if (distance < 100) {
                this.x -= dx * 0.02;
                this.y -= dy * 0.02;
            }

            if (this.x > canvas.width) this.x = 0;
            if (this.x < 0) this.x = canvas.width;
            if (this.y > canvas.height) this.y = 0;
            if (this.y < 0) this.y = canvas.height;
        }

        draw() {
            if (!ctx) return;
            ctx.fillStyle = this.color;
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.fill();
        }
    }

    function init() {
        canvas = document.getElementById(
            "background-canvas",
        ) as HTMLCanvasElement;
        if (!canvas) return;
        ctx = canvas.getContext("2d");

        resize();

        particles = [];
        const numberOfParticles = Math.min(
            100,
            (canvas.width * canvas.height) / 15000,
        );
        for (let i = 0; i < numberOfParticles; i++) {
            particles.push(new Particle());
        }
    }

    function resize() {
        if (!canvas) return;
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }

    function animate() {
        if (!ctx || !canvas) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        particles.forEach((particle) => {
            particle.update();
            particle.draw();
        });

        particles.forEach((a, index) => {
            particles.slice(index + 1).forEach((b) => {
                const dx = a.x - b.x;
                const dy = a.y - b.y;
                const distance = Math.sqrt(dx * dx + dy * dy);

                if (distance < 100) {
                    if (ctx) {
                        ctx.strokeStyle = `rgba(139, 92, 246, ${0.1 - distance / 1000})`;
                        ctx.lineWidth = 0.5;
                        ctx.beginPath();
                        ctx.moveTo(a.x, a.y);
                        ctx.lineTo(b.x, b.y);
                        ctx.stroke();
                    }
                }
            });
        });

        animationId = requestAnimationFrame(animate);
    }

    // Setup event listeners
    function setup() {
        init();
        if (animationId) cancelAnimationFrame(animationId);
        animate();

        window.addEventListener("resize", resize);
        window.addEventListener("mousemove", (e) => {
            mouse.x = e.clientX;
            mouse.y = e.clientY;
        });
    }

    // Run on initial load
    setup();

    // Handle View Transitions
    document.addEventListener("astro:page-load", () => {
        // Re-check canvas and restart if needed
        const newCanvas = document.getElementById(
            "background-canvas",
        ) as HTMLCanvasElement;
        if (newCanvas && newCanvas !== canvas) {
            // If canvas element changed (shouldn't with persist, but just in case)
            setup();
        } else if (canvas) {
            // Ensure size is correct
            resize();
        }
    });
</script>

<style>
    #background-canvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
        pointer-events: none;
        background-color: #0e021b;
    }
</style>
